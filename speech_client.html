<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sam Voice</title>
    <style>
        body {
            margin: 0; padding: 20px;
            background: #000;
            color: #8ffcff;
            font-family: Consolas, monospace;
            font-size: 13px;
        }
        #mode   { font-size: 16px; font-weight: bold; margin-bottom: 8px; }
        #status { color: #555; margin-bottom: 6px; }
        #last   { color: #8ffcff; word-break: break-word; }
        .passive { color: #005588; }
        .active  { color: #00ccff; }
        .suppressed { color: #333; }
    </style>
</head>
<body>
    <div id="mode" class="passive">● PASSIVE — say "Hey Sam"</div>
    <div id="status">Connecting...</div>
    <div id="last"></div>

<script>
// ── Constants ──────────────────────────────────────────────────
const WAKE_PHRASES = ['hey sam', 'hey, sam', 'ok sam', 'okay sam', 'hi sam'];
const ACTIVE_TIMEOUT_MS = 30000;   // return to passive after 30 s of silence in conversation mode

// ── State ──────────────────────────────────────────────────────
let mode = 'passive';              // 'passive' | 'active' | 'suppressed'
let prevMode = 'passive';          // saved mode while suppressed
let activeTimer = null;
let recognition = null;
let ws = null;
let wsReady = false;

// ── UI helpers ─────────────────────────────────────────────────
const modeEl   = document.getElementById('mode');
const statusEl = document.getElementById('status');
const lastEl   = document.getElementById('last');

function setMode(m) {
    mode = m;
    if (m === 'passive') {
        modeEl.textContent = '● PASSIVE — say "Hey Sam"';
        modeEl.className = 'passive';
    } else if (m === 'active') {
        modeEl.textContent = '● ACTIVE — listening…';
        modeEl.className = 'active';
    } else {
        modeEl.textContent = '● Sam is speaking…';
        modeEl.className = 'suppressed';
    }
}

function setStatus(s) { statusEl.textContent = s; }
function setLast(t)   { lastEl.textContent = t ? `"${t}"` : ''; }

// ── Active mode timeout ────────────────────────────────────────
function resetActiveTimer() {
    if (activeTimer) clearTimeout(activeTimer);
    activeTimer = setTimeout(() => setMode('passive'), ACTIVE_TIMEOUT_MS);
}

function enterActive() {
    setMode('active');
    resetActiveTimer();
}

// ── WebSocket ──────────────────────────────────────────────────
function connectWS() {
    ws = new WebSocket('ws://localhost:8765');

    ws.onopen = () => {
        wsReady = true;
        setStatus('Connected');
        startRecognition();
    };

    ws.onclose = () => {
        wsReady = false;
        setStatus('Disconnected — retrying…');
        setTimeout(connectWS, 3000);
    };

    ws.onerror = () => {
        setStatus('WS error');
    };

    ws.onmessage = (evt) => {
        try {
            const msg = JSON.parse(evt.data);
            if (msg.type !== 'command') return;

            switch (msg.action) {
                case 'sam_speaking':
                    prevMode = (mode !== 'suppressed') ? mode : prevMode;
                    pauseRecognition();
                    setMode('suppressed');
                    break;

                case 'sam_done':
                    // Stay in active/conversation mode after Sam replies — user can continue talking
                    resumeRecognition();
                    enterActive();
                    break;

                case 'set_active':
                    enterActive();
                    break;

                case 'set_passive':
                    setMode('passive');
                    break;

                // Legacy compatibility — ignored in wake-word mode
                case 'start_listening':
                    if (mode !== 'suppressed') enterActive();
                    break;

                case 'stop_listening':
                    setMode('passive');
                    break;
            }
        } catch(e) {}
    };
}

function send(payload) {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(payload));
    }
}

// ── Speech recognition ─────────────────────────────────────────
function startRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        setStatus('Speech API not supported — use Chrome/Edge');
        return;
    }

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    recognition.maxAlternatives = 1;

    recognition.onstart  = () => setStatus('Microphone active');
    recognition.onerror  = (e) => {
        setStatus(`Error: ${e.error}`);
        if (e.error !== 'aborted') setTimeout(() => safeStart(), 1500);
    };
    recognition.onend    = () => {
        // Auto-restart unless suppressed
        if (mode !== 'suppressed') {
            setTimeout(() => safeStart(), 300);
        }
    };

    recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (!event.results[i].isFinal) continue;

            const raw   = event.results[i][0].transcript.trim();
            const lower = raw.toLowerCase();
            setLast(raw);

            if (mode === 'suppressed') return;  // Sam is talking — ignore

            // ── Wake word detection ────────────────────────────
            let queryText = null;
            for (const phrase of WAKE_PHRASES) {
                if (lower.startsWith(phrase)) {
                    queryText = raw.slice(phrase.length).trim();
                    break;
                }
                // Wake word embedded (e.g. "actually hey sam what time is it")
                const idx = lower.indexOf(phrase);
                if (idx !== -1) {
                    queryText = raw.slice(idx + phrase.length).trim();
                    break;
                }
            }

            if (queryText !== null) {
                // Wake word was heard
                enterActive();
                if (queryText.length > 2) {
                    // Full query in same utterance — send immediately
                    setStatus(`Sending: "${queryText}"`);
                    send({ type: 'transcript', text: queryText, isFinal: true });
                    setMode('passive');
                } else {
                    // Just "Hey Sam" — stay active, wait for next utterance
                    setStatus('Listening for your question…');
                    send({ type: 'wake_word' });
                }
                return;
            }

            // ── Active mode — pass through ─────────────────────
            if (mode === 'active' && raw.length > 2) {
                setStatus(`Sending: "${raw}"`);
                send({ type: 'transcript', text: raw, isFinal: true });
                // Don't drop back to passive — Sam will respond, then sam_done fires
                // and enterActive() keeps the conversation going automatically.
                resetActiveTimer();
                return;
            }

            // Passive and no wake word — ignore
        }
    };

    safeStart();
}

let _starting = false;
function safeStart() {
    if (_starting || !recognition) return;
    _starting = true;
    try { recognition.start(); } catch(e) {}
    setTimeout(() => { _starting = false; }, 500);
}

function pauseRecognition() {
    if (recognition) { try { recognition.stop(); } catch(e) {} }
}

function resumeRecognition() {
    setTimeout(() => safeStart(), 400);
}

// ── Boot ───────────────────────────────────────────────────────
window.onload = connectWS;
</script>
</body>
</html>
